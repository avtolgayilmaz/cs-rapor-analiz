<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-CS Audit Pro | Tam Denetim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .ai-card { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        .ai-card:hover { border-color: #6366f1; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .status-pill { padding: 4px 10px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .log-row:nth-child(even) { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div class="max-w-7xl mx-auto py-8 px-4">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-indigo-900 tracking-tight">AI-CS <span class="text-indigo-500">Audit Engine</span></h1>
                <p class="text-slate-500 font-medium">Şikayet Analizi, 24s Kilidi ve Vardiya Denetimi</p>
            </div>
            
            <div class="flex items-center gap-3 bg-indigo-50 p-3 rounded-2xl border border-indigo-100">
                <div class="text-right">
                    <p class="text-[10px] font-bold text-indigo-400 uppercase leading-none">OpenAI API Key</p>
                    <input type="password" id="apiKey" placeholder="sk-..." class="bg-transparent text-sm font-mono focus:outline-none w-40 text-indigo-900">
                </div>
                <div class="h-8 w-px bg-indigo-200"></div>
                <button onclick="alert('API Key tarayıcı hafızasında saklanmaz.')" class="text-indigo-400 hover:text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="ai-card p-5">
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Toplam Rapor</p>
                <h3 id="statTotal" class="text-2xl font-bold mt-1">0</h3>
            </div>
            <div class="ai-card p-5 border-l-4 border-l-red-500">
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Hata Tespiti (AI)</p>
                <h3 id="statErrors" class="text-2xl font-bold mt-1 text-red-600">0</h3>
            </div>
            <div class="ai-card p-5 border-l-4 border-l-amber-500">
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">24s Kilidine Takılan</p>
                <h3 id="statLocked" class="text-2xl font-bold mt-1 text-amber-600">0</h3>
            </div>
            <div class="ai-card p-5 border-l-4 border-l-emerald-500">
                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Başarı Oranı</p>
                <h3 id="statSuccess" class="text-2xl font-bold mt-1 text-emerald-600">%0</h3>
            </div>
        </div>

        <div class="bg-white p-8 rounded-3xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center mb-8 hover:border-indigo-300 transition-colors">
            <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-slate-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <button onclick="document.getElementById('excelFile').click()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition transform hover:-translate-y-0.5">Excel Dosyasını Yükle</button>
            <p id="fileInfo" class="mt-3 text-sm text-slate-400 uppercase font-bold tracking-tighter"></p>
        </div>

        <div class="flex justify-center mb-10">
            <button id="runBtn" disabled onclick="runFullAudit()" class="group relative flex items-center gap-3 bg-slate-900 text-white px-10 py-4 rounded-2xl font-bold disabled:opacity-30 disabled:cursor-not-allowed hover:bg-black transition-all">
                <span>AI DENETİMİNİ BAŞLAT</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </button>
        </div>

        <div class="ai-card overflow-hidden shadow-xl">
            <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                <h2 class="font-bold text-slate-700">Denetim Günlüğü</h2>
                <div id="progressText" class="text-xs font-bold text-indigo-600 italic">Hazır</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[11px] text-slate-400 uppercase tracking-widest bg-white">
                            <th class="p-4 border-b">Tarih / Oyuncu</th>
                            <th class="p-4 border-b">Şikayet İçeriği</th>
                            <th class="p-4 border-b">CS Aksiyon</th>
                            <th class="p-4 border-b">Sistem Durumu</th>
                            <th class="p-4 border-b w-64">AI Kararı</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let lockedUsers = {}; // 24 saat takibi için: { userID: lastMuteTimestamp }

        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            document.getElementById('fileInfo').innerText = file.name;
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, {type:'binary'});
                const wsname = wb.SheetNames[0];
                rawData = XLSX.utils.sheet_to_json(wb.Sheets[wsname]);
                document.getElementById('statTotal').innerText = rawData.length;
                document.getElementById('runBtn').disabled = false;
            };
            reader.readAsBinaryString(file);
        });

        async function runFullAudit() {
            const apiKey = document.getElementById('apiKey').value;
            if(!apiKey) return alert("Hata: Lütfen OpenAI API Key giriniz.");

            const tableBody = document.getElementById('tableBody');
            const runBtn = document.getElementById('runBtn');
            tableBody.innerHTML = '';
            runBtn.disabled = true;

            let errorCount = 0;
            let lockCount = 0;

            // Tarihe göre sırala (24 saat kilidi için önemli)
            rawData.sort((a, b) => new Date(a.Tarih) - new Date(b.Tarih));

            for (let i = 0; i < rawData.length; i++) {
                const row = rawData[i];
                const rowId = row["OyuncuID"] || "Bilinmeyen";
                const rowDate = moment(row["Tarih"]);
                const rowContent = row["Sikayet_Metni"] || "";
                const csAction = row["Aksiyon"] === "24s_mute"; // Excel'deki karşılığa göre güncelle

                let systemStatus = "";
                let isLocked = false;

                // 1. 24 SAAT KİLİDİ KONTROLÜ
                if (lockedUsers[rowId]) {
                    const diff = rowDate.diff(lockedUsers[rowId], 'hours');
                    if (diff < 24) {
                        isLocked = true;
                        lockCount++;
                        systemStatus = `<span class="status-pill bg-amber-100 text-amber-700">LOCKED (24s)</span>`;
                    }
                }

                // Eğer CS mute atmışsa, kilit süresini güncelle
                if (csAction) {
                    lockedUsers[rowId] = rowDate;
                }

                // 2. AI ANALİZİ (Eğer kilitli değilse daha önemli)
                let aiFeedback = "Analiz Ediliyor...";
                let finalStatus = "";

                const tr = document.createElement('tr');
                tr.className = "log-row transition-all";
                tr.innerHTML = `
                    <td class="p-4 border-b font-mono text-[12px]">${rowDate.format('DD.MM HH:mm')}<br><span class="text-slate-400 font-sans italic">${rowId}</span></td>
                    <td class="p-4 border-b text-slate-600 italic">"${rowContent.substring(0, 100)}..."</td>
                    <td class="p-4 border-b font-bold text-xs">${csAction ? '✅ 24S MUTE' : '❌ PAS GEÇİLDİ'}</td>
                    <td class="p-4 border-b">${systemStatus || '<span class="status-pill bg-blue-50 text-blue-600">NORMAL</span>'}</td>
                    <td id="ai-${i}" class="p-4 border-b text-xs font-medium text-indigo-700">...</td>
                `;
                tableBody.prepend(tr); // En yeni analizi üste koy

                if (!isLocked) {
                    try {
                        const response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({
                                model: "gpt-4o-mini",
                                messages: [{
                                    role: "system",
                                    content: "Sen bir oyun moderasyon denetçisisin. Kural: Sadece küfür, hakaret ve tacize 24s mute verilir. Gelen şikayet bu kuralı ihlal ediyorsa ve CS aksiyon almadıysa veya ihlal yokken aksiyon aldıysa bunu belirt."
                                }, {
                                    role: "user",
                                    content: `İçerik: "${rowContent}" | CS Aksiyonu: ${csAction ? 'Mute Verildi' : 'Verilmedi'}. Bu karar doğru mu? Cevabı şu formatta ver: [DURUM] - Kısa Neden.`
                                }],
                                max_tokens: 100
                            })
                        });

                        const data = await response.json();
                        aiFeedback = data.choices[0].message.content;
                        
                        if(aiFeedback.includes("HATALI") || aiFeedback.includes("YANLIŞ")) {
                            errorCount++;
                            tr.classList.add('bg-red-50');
                            document.getElementById(`ai-${i}`).innerHTML = `<span class="text-red-600 font-bold">⚠️ ${aiFeedback}</span>`;
                        } else {
                            document.getElementById(`ai-${i}`).innerHTML = `<span class="text-emerald-600">✅ ${aiFeedback}</span>`;
                        }
                    } catch (e) {
                        document.getElementById(`ai-${i}`).innerText = "API Hatası!";
                    }
                } else {
                    document.getElementById(`ai-${i}`).innerHTML = `<span class="text-slate-400">Kilitli: Analiz Gerekmiyor</span>`;
                }

                // İstatistikleri Güncelle
                document.getElementById('statErrors').innerText = errorCount;
                document.getElementById('statLocked').innerText = lockCount;
                document.getElementById('statSuccess').innerText = `%${Math.round(((i+1 - errorCount)/(i+1))*100)}`;
                document.getElementById('progressText').innerText = `%${Math.round(((i + 1) / rawData.length) * 100)} Tamamlandı`;
            }
            runBtn.disabled = false;
        }
    </script>
</body>
</html>

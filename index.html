<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-CS AUDIT | Siyah & Sarı Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { 
            background-color: #0f172a; /* Çok koyu lacivert/siyah */
            font-family: 'JetBrains Mono', monospace; 
        }

        .yellow-accent { color: #facc15; }
        .bg-yellow-accent { background-color: #facc15; }
        .border-yellow-accent { border-color: #facc15; }

        .ai-card { 
            background: #1e293b; 
            border: 1px solid #334155; 
            transition: all 0.2s ease;
        }
        
        .ai-card:hover { 
            border-color: #facc15;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.1);
        }

        /* Kaydırma çubuğu özelleştirme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #facc15; }

        .status-pill { 
            padding: 2px 10px; 
            border-radius: 4px; 
            font-size: 0.65rem; 
            font-weight: 800;
        }
    </style>
</head>
<body class="text-slate-200 p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 border-b border-slate-800 pb-6">
            <div class="text-center md:text-left">
                <h1 class="text-4xl font-black tracking-tighter yellow-accent uppercase italic">
                    CS <span class="bg-yellow-accent text-black px-2 ml-1">AUDIT</span> SYSTEM
                </h1>
                <p class="text-slate-500 text-xs mt-2 font-bold uppercase tracking-widest">Yapay Zeka Destekli Operasyonel Denetim Paneli</p>
            </div>
            
            <div class="mt-6 md:mt-0 flex items-center gap-4 bg-slate-800 p-4 rounded-lg border border-slate-700">
                <div>
                    <p class="text-[10px] font-bold yellow-accent uppercase mb-1">OPENAI AUTH TOKEN</p>
                    <input type="password" id="apiKey" placeholder="sk-..." class="bg-slate-900 border border-slate-700 text-yellow-500 text-xs p-2 w-48 focus:outline-none focus:border-yellow-500">
                </div>
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="ai-card p-6 border-l-4 border-l-yellow-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase">Toplam Kayıt</p>
                <h3 id="statTotal" class="text-3xl font-black yellow-accent">0</h3>
            </div>
            <div class="ai-card p-6 border-l-4 border-l-red-600">
                <p class="text-slate-500 text-[10px] font-bold uppercase">Hatalı Karar</p>
                <h3 id="statErrors" class="text-3xl font-black text-red-500">0</h3>
            </div>
            <div class="ai-card p-6 border-l-4 border-l-blue-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase">24s Kilidi</p>
                <h3 id="statLocked" class="text-3xl font-black text-blue-400">0</h3>
            </div>
            <div class="ai-card p-6 border-l-4 border-l-green-500">
                <p class="text-slate-500 text-[10px] font-bold uppercase">Başarı Skoru</p>
                <h3 id="statSuccess" class="text-3xl font-black text-green-500">%0</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <div class="ai-card p-8 border-2 border-dashed border-slate-700 flex flex-col items-center justify-center group cursor-pointer" onclick="document.getElementById('excelFile').click()">
                <input type="file" id="excelFile" class="hidden" accept=".xlsx, .xls">
                <div class="bg-slate-800 p-4 rounded-full mb-4 group-hover:bg-yellow-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-500 group-hover:text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                </div>
                <span id="fileInfo" class="text-xs font-bold text-slate-400 uppercase tracking-widest">Dosya Yükle (.xlsx)</span>
            </div>

            <div class="ai-card p-8 flex flex-col items-center justify-center">
                <button id="runBtn" disabled onclick="runFullAudit()" class="w-full bg-yellow-500 text-black py-4 rounded font-black uppercase hover:bg-yellow-400 disabled:opacity-20 disabled:grayscale transition-all shadow-lg shadow-yellow-900/20">
                    AI ANALİZİNİ TETİKLE
                </button>
                <p id="progressText" class="text-[10px] mt-4 font-bold text-slate-500 uppercase tracking-widest italic text-center">Sistem Beklemede</p>
            </div>
        </div>

        <div class="ai-card rounded-none border-t-4 border-t-yellow-500">
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-slate-900 border-b border-slate-700">
                            <th class="p-4 text-[10px] yellow-accent uppercase">Time / ID</th>
                            <th class="p-4 text-[10px] yellow-accent uppercase">Report Content</th>
                            <th class="p-4 text-[10px] yellow-accent uppercase">CS Action</th>
                            <th class="p-4 text-[10px] yellow-accent uppercase">Status</th>
                            <th class="p-4 text-[10px] yellow-accent uppercase w-1/3">AI Evaluation</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-800">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let lockedUsers = {};

        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            document.getElementById('fileInfo').innerText = file.name;
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, {type:'binary'});
                rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                document.getElementById('statTotal').innerText = rawData.length;
                document.getElementById('runBtn').disabled = false;
            };
            reader.readAsBinaryString(file);
        });

        async function runFullAudit() {
            const apiKey = document.getElementById('apiKey').value;
            if(!apiKey) return alert("Hata: API Key Gerekli!");

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            let errors = 0, locks = 0;
            rawData.sort((a, b) => new Date(a.Tarih) - new Date(b.Tarih));

            for (let i = 0; i < rawData.length; i++) {
                const row = rawData[i];
                const player = row["OyuncuID"] || "UNK-PLAYER";
                const date = moment(row["Tarih"]);
                const text = row["Sikayet_Metni"] || "";
                const isMuted = row["Aksiyon"] === "24s_mute";

                let isLocked = false;
                if (lockedUsers[player] && date.diff(lockedUsers[player], 'hours') < 24) {
                    isLocked = true;
                    locks++;
                }
                if (isMuted) lockedUsers[player] = date;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800/50 transition-colors";
                tr.innerHTML = `
                    <td class="p-4 font-mono text-[11px] border-r border-slate-800">
                        <span class="text-yellow-500">${date.format('HH:mm:ss')}</span><br>
                        <span class="text-slate-500">${date.format('DD/MM/YY')}</span><br>
                        <span class="text-white font-bold">${player}</span>
                    </td>
                    <td class="p-4 text-[12px] text-slate-400 italic font-sans leading-relaxed border-r border-slate-800">"${text.substring(0,120)}..."</td>
                    <td class="p-4 border-r border-slate-800">
                        <span class="status-pill ${isMuted ? 'bg-yellow-500 text-black' : 'bg-slate-700 text-slate-400'}">${isMuted ? 'MUTE' : 'NO ACTION'}</span>
                    </td>
                    <td class="p-4 border-r border-slate-800 text-center">
                        ${isLocked ? '<span class="status-pill bg-blue-900 text-blue-300">LOCKED</span>' : '<span class="status-pill bg-slate-900 text-slate-500">OPEN</span>'}
                    </td>
                    <td id="ai-${i}" class="p-4 text-[11px] font-bold">ANALYZING...</td>
                `;
                tableBody.prepend(tr);

                if (!isLocked) {
                    try {
                        const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({
                                model: "gpt-4o-mini",
                                messages: [
                                    {role: "system", content: "Sen sert bir oyun denetçisisin. Kurallar: Küfür, hakaret, spam = 24s mute. Hata varsa [HATALI] yaz."},
                                    {role: "user", content: `Metin: ${text} | Karar: ${isMuted ? 'Mute' : 'Yok'}`}
                                ]
                            })
                        });
                        const data = await resp.json();
                        const result = data.choices[0].message.content;
                        const hasError = result.includes("HATALI") || result.includes("ERROR");
                        
                        if(hasError) {
                            errors++;
                            document.getElementById(`ai-${i}`).innerHTML = `<span class="text-red-500">⚠️ ${result}</span>`;
                            tr.classList.add('bg-red-900/10');
                        } else {
                            document.getElementById(`ai-${i}`).innerHTML = `<span class="text-green-500">OK: ${result}</span>`;
                        }
                    } catch (e) {
                        document.getElementById(`ai-${i}`).innerText = "CONNECTION ERROR";
                    }
                } else {
                    document.getElementById(`ai-${i}`).innerHTML = `<span class="text-slate-600">SKIP: 24h LOCK ACTIVE</span>`;
                }

                // Stats Update
                document.getElementById('statErrors').innerText = errors;
                document.getElementById('statLocked').innerText = locks;
                document.getElementById('statSuccess').innerText = `%${Math.round(((i+1-errors)/(i+1))*100)}`;
                document.getElementById('progressText').innerText = `DENETİM: %${Math.round(((i+1)/rawData.length)*100)} TAMAMLANDI`;
            }
        }
    </script>
</body>
</html>
